# 程式語言課程實作一通訊錄檔案

[TOC]



# 一、做法

## 1.	題目定義

### 1.1	簡介

實作一個通訊錄檔案，要有能對其做維護的功能（詳細功能請見第ｃ點）。此檔案有**本地端歷史保存性**（關閉檔案後，下次再打開狀態會如同前次退出前），並有**可攜性**（只要複製紀錄便可在另一可執行環境使用）。

### 1.2	聯絡人格式欄位及輸入說明

- 加入時的時間戳：
  - 單值。
  - 為聯絡人之主鍵。
  - 不可被使用者修改。
  - 不須使用者輸入，由程式自動生成。
- 名稱：
  - 單值。
  - 為使用者必填選項，不得為空。
  - 可被使用者修改。
  - 所含空格將被忽略（假如輸入帶有空格，將自動被剔除）。
- 暱稱：
  - 單值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 所含空格將被忽略（假如輸入帶有空格，將自動被剔除）。
- 生日：
  - 單值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 所含空格將被忽略（假如輸入帶有空格，將自動被剔除）。
  - 所輸入的日期不合乎常理將視為無效輸入（考慮閏平年的日期、是否在輸入時的時間之前）。
  - 有效輸入格式有兩種：
    - 西元年/月/日：YYYY/MM/DD
    - 月日：MM/DD
      (斜線為半形、全形皆可。)
- 星座：
  - 單值。
  - 不須使用者輸入，由所填的生日自動生成（因此若無生日的值，便無星座的值）。
  - 儲存及能被搜尋功能搜尋的樣式為：魔羯座、水瓶座、雙魚座、白羊座、金牛座、雙子座、巨蟹座、獅子座、處女座、天秤座、天蠍座、射手座
- 家用電話：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 非數字將被忽略（假如輸入帶有非數字，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- 手機：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 非數字將被忽略（假如輸入帶有非數字，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- 公司電話：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 非數字將被忽略（假如輸入帶有非數字，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- 通訊地址：
  - 單值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 所含空格將被忽略（假如輸入帶有空格，將自動被剔除）。
  - 輸入格式：
    國家地區/縣市/區鄉鎮/其它
    (若有不填的欄位，需填入"x”。)
    (斜線為半形、全形皆可。)
- Email：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 除了”.”和"@"和"_"，其它標點符號和空格將被忽略（假如輸入帶有，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- Line ID：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 除了"_"，其它標點符號和空格將被忽略（假如輸入帶有，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- Facebook ID：
  - 多值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 除了"_"，其它標點符號和空格將被忽略（假如輸入帶有，將自動被剔除）。
  - 輸入若為多值，須以逗號分割（半形、全形皆可）。
- 備註：
  - 單值。
  - 為使用者選填選項，可為空。
  - 可被使用者修改。
  - 長度限制為200字（大於的部份將自動被剔除）。

### 1.3 使用者可使用功能（使用選單結構）

- 聯絡人列表
  - 依加入時間全排序顯示(舊 -> 新)
  - 依加入時間全排序顯示(新 -> 舊)
  - 依姓名字首拼音順序全排序顯示(A -> Z)
  - 依姓名字首拼音倒序全排序顯示(Z -> A)
  - 依分組顯示
    - 全組別分類顯示
    - 選擇組別顯示
    - 回上一層
    - 回主選單
    - 關閉通訊錄
  - 依生日顯示
    - 依年份順序分類全排序顯示
    - 依年份倒序分類全排序顯示
    - 選擇年份顯示
    - 依月份順序分類全排序顯示
    - 依月份倒序分類全排序顯示
    - 選擇月份顯示
    - 依日期(=按年齡)順序全排序顯示
    - 依日期(=按年齡)倒序全排序顯示
    - 回上一層
    - 回主選單
    - 關閉通訊錄
  - 依年齡顯示
    - 年齡順序分類全排序顯示
    - 年齡倒序分類全排序顯示
    - 選擇年齡顯示
    - 回上一層
    - 回主選單
    - 關閉通訊錄
  - 依星座顯示
    - 星座分類全排序顯示
    - 選擇星座顯示
    - 回上一層
    - 回主選單
    - 關閉通訊錄
  - 依縣市分類顯示
    - 縣市分類全排序顯示
    - 選擇縣市顯示
    - 回上一層
    - 回主選單
    - 關閉通訊錄
  - 回主選單
  - 關閉通訊錄
- 搜尋聯絡人
  - 依名稱(姓名/暱稱)(為部分符合搜尋)
  - 依電話(為部分符合搜尋)
  - 依生日年份(為完全符合搜尋)
  - 依生日月份(為完全符合搜尋)
  - 依星座(為完全符合搜尋)
  - 依年齡(為完全符合搜尋)
  - 依縣市(為完全符合搜尋)
  - 回主選單
  - 關閉通訊錄
- 新增聯絡人（輸入格式請參見第ｂ點）
- 刪除聯絡人
  - 依名稱(姓名/暱稱)搜尋結果挑選
  - 依電話搜尋結果挑選
  - 依生日年份搜尋結果挑選
  - 依生日月份搜尋結果挑選
  - 依星座搜尋結果挑選
  - 依年齡搜尋結果挑選
  - 依縣市搜尋結果挑選
  - 回主選單
  - 關閉通訊錄
- 分組聯絡人
  - 依分組列出目前聯絡人
  - 選擇組別列出聯絡人
  - 添加聯絡人到組別
  - 將聯絡人移出組別
  - 新增分組
  - 刪除分組
  - 回主選單
  - 關閉通訊錄
- 修改聯絡資訊
  - 依名稱(姓名/暱稱)搜尋結果挑選
  - 依電話搜尋結果挑選
  - 依生日年份搜尋結果挑選
  - 依生日月份搜尋結果挑選
  - 依星座搜尋結果挑選
  - 依年齡搜尋結果挑選
  - 依縣市搜尋結果挑選
  - 回主選單
  - 關閉通訊錄
- 關閉通訊錄

## 2. 資料結構

### 2.1  class Birthday

#### 
特別用來儲存及處理聯絡人（class ContactPerson）的（生日birthday）所建造。

#### 成員變數結構

- year
  - type: string
  - 生日西年年份
- month
  - type: string
  - 生日月份
- day
  - type: string
  - 生日日期

### 2.2 class Address

#### 
特別用來儲存及處理聯絡人（class ContactPerson）的地址（address）所建造。

#### 成員變數結構

- region
  - type: string
  - 國家/地區
- county
  - type: string
  - 縣市
- district
  - type: string
  - 區/鄉/鎮
- detail
  - type: string
  - 其他詳細地址

### 2.3  class ContactPerson

#### 
特別用來儲存通訊錄中（class Directory）聯絡人所建造。

#### 成員變數結構

- time
  - type: datetime.datetime
  - 聯絡人被加入通訊錄的時間戳
  - 採用格式: %Y-%m-%d %H:%M:%S.%f
- name
  - type: string
  - 聯絡人名稱
- alias
  - type: string
  - 聯絡人暱稱
- birthday
  - type: Birthday
  - 聯絡人生日
- constellation
  - type: string
  - 根據聯絡人生日所生成的星座
  - 樣式: 魔羯座、水瓶座、雙魚座、白羊座、金牛座、雙子座、巨蟹座、獅子座、處女座、天秤座、天蠍座、射手座
- home_phones
  - type: list (元素全為 string)
  - 聯絡人家用電話列表
- mobile_phones
  - type: list (元素全為 string)
  - 聯絡人手機列表
- company_phones
  - type: list (元素全為 string)
  - 聯絡人公司電話列表
- address
  - type: Address
  - 聯絡人地址
- emails
  - type: list (元素全為 string)
  - 聯絡人 Email 列表
- line_ids
  - type: list (元素全為 string)
  - 聯絡人 Line ID 列表
- facebook_ids
  - type: list (元素全為 string)
  - 聯絡人 Facebook ID 列表
- note
  - type: string
  - 聯絡人備註欄
  - 長度限制：２００字

### 2.4  class Directory

#### 
主要用來操作、維護此通訊錄檔案程式的類別。

#### 成員變數結構

- data_path
  - type: string
  - 儲存通訊錄紀錄檔案的路徑
  - 預設完成，不可被外部更改
- contacts_dict
  - type: dictionary
  - 元素結構請參見記錄檔案結構的儲存格式樣貌
  - 儲存聯絡人
  - 用於對照主鍵及存檔用
- contacts_list
  - type: list （元素全為 ContactPerson）
  - 此通訊錄的聯絡人列表
  - 用來執行聯絡人資料維護用
  - 在程式被啟動時，會從記錄檔案中 parse 出來一個個 ContactPerosn存放於此
- groups_dict
  - type: dictionary
  - 元素主鍵為分組名稱，值為一列表（list），內存放在此分組中的聯絡人之主鍵（聯絡人被加入通訊錄的時間戳）。

## 3. 演算法

### 3.1 搜尋

#### 3.1.1 部分符合的聯絡人搜尋（姓名/暱稱/電話號碼）

先對聯絡人列表進行一次迴圈，並在內比對所要的姓名/暱稱/電話號碼字串中，是否有＂部分含有＂要搜尋的字串，將其串成一 list。
再對此列表進行一次迴圈，印出其內容。
其中針對電話號碼的部分，需要先對家用電話/手機/公司電話，分別進行一次迴圈（共三個迴圈），串成一大字串再回傳以供搜尋是否＂部分含有＂電話號碼的部分。
因此姓名與暱稱需要兩個迴圈，而電話號碼則需進行五個迴圈，時間複雜度便是其個別長度相加（可能會有中途離開迴圈的情況，便是其最大長度相加）。

#### 3.1.2 全部符合的聯絡人搜尋（生日年份/生日月份/星座/年齡/縣市）

這幾個項目需要先進行一次迴圈，將所需的項目parse 成 list(請見的特別處理功能的viii.)。
再對此列表進行一次迴圈搜索，串起一個符合搜索條件的結果 list。
再對此列表進行一次迴圈，印出其內容。
總共進行三個迴圈，時間複雜度便是其個別長度相加（可能會有中途離開迴圈的情況，便是其最大長度相加）。

#### 3.1.3 全組別搜尋

須對組別dict.進行迴圈，在內再對所存儲的聯絡人時間戳list進行迴圈，在內再對聯絡人列表進行迴圈以比對取得相同時間戳的是哪個聯絡人，將此些聯絡人串成一list，元素結構為”(分組名稱, [成員列表...])。
以上總共三層迴圈，最大時間複雜度便是其最大長度的相乘。
再對此list進行迴圈，在內又對其成員列表進行迴圈找尋符合的對象。最大時間複雜度再加上此列表長度。

### 3.2 聯絡人排序

#### 3.2.1 默認：儲存於字典中的順序（也就是無序，但通常為加入順序）。

#### 3.2.2 選擇按照加入的日期排序

先對所有聯絡人進行一次迴圈採集其加入時間戳，採用基本型時間複雜度O(n log n)的Quick Sort。
總共最大總複雜度是聯絡人列表長度+O(n log n)。

#### 3.2.3 選擇按照名字的字首拼音排序

先對所有聯絡人名字利用外部庫分析成拼音列表，再對此列表一次迴圈採集其字首，最後採用基本型時間複雜度O(n2)的Quick Sort利用字首進行排序。
總共最大總複雜度是聯絡人列表長度+O(n log n)。

#### 3.2..4 選擇按照生日年份/生日月份/生日日期/年齡排序

先對所有聯絡人列表進行一次迴圈，分類出一個dict.，再對這個字典進行一次迴圈印出結果。

## 4. 特別說明

### 4.1 源碼語言

Python3

### 4.2 使用函式庫

- sys
- io
- os
- datetime
- re
- copy
- json
- codecs
- pypinyin => 參考 https://github.com/mozillazg/python-pinyin

### 4.3 記錄檔案結構

- 用來記錄通訊錄資料的檔案，在此採用了 json 檔案格式處理。

- 存在 data 資料夾中的 contacts.json。

- 初始檔案內容樣貌（無任何聯絡人時）:
  ＝＞　{"contacts": {}, "groups": {}}
  （PS. 檔案若毀損（不保持初始樣貌或儲存格式樣貌），則程式執行會無法。）

- 儲存格式樣貌（以下以一位聯絡人及一個分組為例）（在 data 資料夾中的 contacts-clear.json 有呈現）：

  ```
  {"contacts": {
  	"contact_person_datetime": {
  			"name": "name",
  			"alias": "alias",
  			"birthday": "birthday",
  			"constellation": "constellation",
  			"home_phones": ["home_phones", "home_phones"],
  			"mobile_phones": ["mobile_phones", "mobile_phones"],
  			"company_phones": ["company_phones", "company_phones"],
  			"address": "address",
  			"emails": ["emails", "emails"],
  			"line_ids": ["line_ids", "line_ids"],
  			"facebook_ids": ["facebook_ids", "facebook_ids"],
  			"note": "note"}},
  	"groups": {
  		"group_name": ["contact_datetime"]}
  }
  ```

### 4.4 程式特別處理功能

- 依所輸入生日計算年齡（請見程式碼directory.py的class Birthday的calculate_age()方法）。
- 依所輸入生日計算星座（請見程式碼directory.py的class ContactPerson的__set_constellation()方法）。
- 聯絡人（class ContactPerson）中的多值、地址、生日、加入時間戳的取得，都提供了分別元儲存型態的值，還有純字串組合的值（依規定輸入格式所串起的字串），其中所有種類的電話號碼也提供一起取得 list 或全串成 string 的方法。
- 自定義的排序規則函數（請見程式碼directory.py的contact_compare_by_time(x, y)、contact_compare_by_name(x, y)、_sort_by_time(x)、_sort_by_name_pinyin(x)等函式）。
- 去除所有無論全形或半形的空白（請見程式碼utils.py的remove_spaces(string)函式）。
- 檢查所輸入的選項是否為合格範圍、是否為純數字（請見程式碼utils.py的check_input_digit(from_range, to_range, enter)函式），並根據所發生問題丟出自定義例外（請見程式碼exception.py的class EmptyEnter, class EnterNotInRange, class EnterNotDigit）。
- 中文字依拼音進行比大小（借助外部庫"pinyin"的幫忙，請見程式碼exception.py的pinyin_y_max(ch_str_x, ch_str_y)函式）。
- 按照dict.的key進行此字典的排序，並輸出成一列表，其元素全為tuple，結構為"(key, [value...])"（請見程式碼exception.py的sorted_dict_by_key_to_list(unsorted_dict, reverse=False)函式）。

# 二、程式碼（略）

# 三、執行結果（略）

# 四、討論

## 1. 選單流程控制

- 困難點：重複一個選擇或跳回上一層或回主選單
- 解決辦法：定義一個中介點的函數來負責轉跳，以及一個字串變數來處理（字串內容像是key一樣標示回到哪裡）。

## 2. 輸入字串的處理格式

- 困難點：使用者輸入情況難以控制
- 解決辦法：只能盡量針對能想到的情況進行例外處理（例如不符合範圍、不能為空），以及對輸入的字串進行分析處理（例如拿掉不該有的字或空白），再者便是寫清楚輸入格式。

## 3. 儲存json的格式處理

- 困難點：雖然json檔案長得像dict.結構，但它不像後者可以儲存很多種型態，在寫入時只能有字串、數字、字典（{}）、列表（[]）；反之要讀取檔案來使用聯絡人也會碰上這麻煩。
- 解決辦法：另外處理需要特殊處理的型態，將其parse成所需的字串結構，再寫入檔案；反之則要parse成可以存為ContactPerson所需的型態。

# 五、心得

## 1. 未完成的遺憾

### 1.1 根據地址搜尋郵遞區號

原先另外建立了class Address其中一個原因，是想方便進行郵遞區號的查詢。但僅僅想到處理3位郵遞區號的方法－－因為郵局有提供檔案可下載（已放在data的資料夾中）。
原先處理方法是進行資料處理然後進行比對搜尋，但因為時間考量，將這項功能的實現放在最後，最後還是沒趕上實作出此項功能，可見事前在時間和架構的相互影響考慮上，和平時進度控管上需要再加強。

### 1.2 更多種的聯絡人列表及搜尋方式

在聯絡人列表和搜尋方式中，我已經盡量提供多種的列表、搜尋方法，但其實並沒有完全實現最當初的設想（例如其實還可以依據國家/地區名稱搜尋或排序）。
但其中最大遺憾是在排序的方法上，固然有幾種可挑的排序方法，但仔細觀察便會發現，在其他種默認排序上根本沒有多加處理，直接按照字典儲存順序輸出。
再者是在中文字首排序上，雖然實現了這個功能，但並不算完整，因為現在的排序方法是找每個字的字首來進行比對（請參考演算法的iii. 選擇按照名字的字首拼音排序），原本想實現的為在字首比對完畢後如果相同，應該要進行筆畫的比對，或是除了字首的其他音做為比對。

### 1.3 圖形化使用介面

原先設想是至少使用Python自帶的 tkinter 完成圖形化的介面，一來在使用上能舒適、方便些；二來在輸入格式的處理上，能夠透過明顯的輸入格或者選擇列表進行控管，減少一些後面的輸入字串處理和力外發生的部分（事實證明，這部分總是佔據編程的大半時間）。
但最後衡量介面設計的時間，決定放棄此實現，再度顯示時間上的控管問題。

## 2. 效率問題

程式中有許多部份需要查找和排序，雖然聯絡人的排序上有採用快速排序，但是那只當選擇依時間戳或名稱排序時時才採用，其他因為大量使用dictionary的型式，或是自定義奇怪的list元素結構，所以無法都採不斷直觀迴圈式的排序甚至不排序，怕是在資料量大的時候，效率會非常慘烈。

## 3. 同步問題

固然現在採用json檔案紀錄，讓紀錄可以保留及攜帶，但一旦攜帶到別的裝置就會發生不同步的問題。
在此其實應該使用網路資料庫進行同步，但事實上是因為json處理較熟練所以可以比較省時間，才選擇這種方法。
